writeup:%20job.job_writeups?.%5B0%5D%20%7C%7C%20null,%0A%20%20%7D));%0A%7D;%0A%0A/*%20============================================%0A%20%20%20FETCH%20JOB%20BY%20JOB%20NUMBER%20OR%20VEHICLE%20REG%0A============================================%20*/%0Aexport%20const%20getJobByNumberOrReg%20=%20async%20(searchTerm)%20=%3E%20%7B%0A%20%20const%20%7B%20data,%20error%20%7D%20=%20await%20supabase%0A%20%20%20%20.from(%22jobs%22)%0A%20%20%20%20.select(%60%0A%20%20%20%20%20%20id,%0A%20%20%20%20%20%20job_number,%0A%20%20%20%20%20%20description,%0A%20%20%20%20%20%20type,%0A%20%20%20%20%20%20status,%0A%20%20%20%20%20%20assigned_to,%0A%20%20%20%20%20%20vehicle:vehicles(%0A%20%20%20%20%20%20%20%20id,%0A%20%20%20%20%20%20%20%20registration,%0A%20%20%20%20%20%20%20%20make,%0A%20%20%20%20%20%20%20%20model,%0A%20%20%20%20%20%20%20%20year,%0A%20%20%20%20%20%20%20%20colour,%0A%20%20%20%20%20%20%20%20vin,%0A%20%20%20%20%20%20%20%20engine_number,%0A%20%20%20%20%20%20%20%20mileage,%0A%20%20%20%20%20%20%20%20fuel_type,%0A%20%20%20%20%20%20%20%20transmission,%0A%20%20%20%20%20%20%20%20body_style,%0A%20%20%20%20%20%20%20%20mot_due,%0A%20%20%20%20%20%20%20%20service_history,%0A%20%20%20%20%20%20%20%20warranty_type,%0A%20%20%20%20%20%20%20%20warranty_expiry,%0A%20%20%20%20%20%20%20%20insurance_provider,%0A%20%20%20%20%20%20%20%20insurance_policy_number,%0A%20%20%20%20%20%20%20%20customer:users(%0A%20%20%20%20%20%20%20%20%20%20id,%0A%20%20%20%20%20%20%20%20%20%20first_name,%0A%20%20%20%20%20%20%20%20%20%20last_name,%0A%20%20%20%20%20%20%20%20%20%20email,%0A%20%20%20%20%20%20%20%20%20%20phone,%0A%20%20%20%20%20%20%20%20%20%20address,%0A%20%20%20%20%20%20%20%20%20%20contact_preference%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20),%0A%20%20%20%20%20%20technician:users(id,%20first_name,%20last_name,%20email),%0A%20%20%20%20%20%20appointments(*),%0A%20%20%20%20%20%20vhc_checks(*),%0A%20%20%20%20%20%20parts_requests(*),%0A%20%20%20%20%20%20job_notes(*),%0A%20%20%20%20%20%20job_writeups(*)%0A%20%20%20%20%60)%0A%20%20%20%20.or(%60job_number.eq.$%7BsearchTerm%7D,vehicle.registration.eq.$%7BsearchTerm%7D%60)%0A%20%20%20%20.single();%0A%0A%20%20if%20(error)%20%7B%0A%20%20%20%20console.error(%22%E2%9D%8C%20Error%20fetching%20job:%22,%20error);%0A%20%20%20%20return%20null;%0A%20%20%7D%0A%0A%20%20return%20%7B%0A%20%20%20%20id:%20data.id,%0A%20%20%20%20jobNumber:%20data.job_number,%0A%20%20%20%20description:%20data.description,%0A%20%20%20%20type:%20data.type,%0A%20%20%20%20status:%20data.status,%0A%20%20%20%20reg:%20data.vehicle?.registration%20%7C%7C%20%22%22,%0A%20%20%20%20make:%20data.vehicle?.make%20%7C%7C%20%22%22,%0A%20%20%20%20model:%20data.vehicle?.model%20%7C%7C%20%22%22,%0A%20%20%20%20year:%20data.vehicle?.year%20%7C%7C%20%22%22,%0A%20%20%20%20colour:%20data.vehicle?.colour%20%7C%7C%20%22%22,%0A%20%20%20%20vin:%20data.vehicle?.vin%20%7C%7C%20%22%22,%0A%20%20%20%20vehicle:%20data.vehicle,%0A%20%20%20%20customer:%20data.vehicle?.customer%0A%20%20%20%20%20%20?%20%60$%7Bdata.vehicle.customer.first_name%7D%20$%7Bdata.vehicle.customer.last_name%7D%60%0A%20%20%20%20%20%20:%20%22%22,%0A%20%20%20%20technician:%20data.technician%0A%20%20%20%20%20%20?%20%60$%7Bdata.technician.first_name%7D%20$%7Bdata.technician.last_name%7D%60%0A%20%20%20%20%20%20:%20%22%22,%0A%20%20%20%20appointment:%20data.appointments?.%5B0%5D%0A%20%20%20%20%20%20?%20%7B%0A%20%20%20%20%20%20%20%20%20%20date:%20data.appointments%5B0%5D.scheduled_time,%0A%20%20%20%20%20%20%20%20%20%20notes:%20data.appointments%5B0%5D.notes%20%7C%7C%20%22%22,%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20:%20null,%0A%20%20%20%20vhcChecks:%20data.vhc_checks%20%7C%7C%20%5B%5D,%0A%20%20%20%20partsRequests:%20data.parts_requests%20%7C%7C%20%5B%5D,%0A%20%20%20%20notes:%20data.job_notes%20%7C%7C%20%5B%5D,%0A%20%20%20%20writeUp:%20data.job_writeups?.%5B0%5D%20%7C%7C%20null,%0A%20%20%7D;%0A%7D;%0A%0A/*%20============================================%0A%20%20%20ADD%20NEW%20JOB%20TO%20DATABASE%0A============================================%20*/%0Aexport%20const%20addJobToDatabase%20=%20async%20(%7B%0A%20%20jobNumber,%0A%20%20reg,%0A%20%20customerId,%0A%20%20assignedTo,%0A%20%20type,%0A%20%20description,%0A%7D)%20=%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20let%20%7B%20data:%20vehicle,%20error:%20vehicleError%20%7D%20=%20await%20supabase%0A%20%20%20%20%20%20.from(%22vehicles%22)%0A%20%20%20%20%20%20.select(%22*%22)%0A%20%20%20%20%20%20.eq(%22registration%22,%20reg)%0A%20%20%20%20%20%20.single();%0A%0A%20%20%20%20if%20(vehicleError%20&&%20vehicleError.code%20===%20%22PGRST116%22)%20%7B%0A%20%20%20%20%20%20const%20%7B%20data:%20newVehicle,%20error:%20newVehicleError%20%7D%20=%20await%20supabase%0A%20%20%20%20%20%20%20%20.from(%22vehicles%22)%0A%20%20%20%20%20%20%20%20.insert(%5B%7B%20registration:%20reg,%20customer_id:%20customerId%20%7D%5D)%0A%20%20%20%20%20%20%20%20.select()%0A%20%20%20%20%20%20%20%20.single();%0A%20%20%20%20%20%20if%20(newVehicleError)%20throw%20newVehicleError;%0A%20%20%20%20%20%20vehicle%20=%20newVehicle;%0A%20%20%20%20%7D%0A%0A%20%20%20%20const%20%7B%20data:%20job,%20error:%20jobError%20%7D%20=%20await%20supabase%0A%20%20%20%20%20%20.from(%22jobs%22)%0A%20%20%20%20%20%20.insert(%5B%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20job_number:%20jobNumber,%0A%20%20%20%20%20%20%20%20%20%20vehicle_id:%20vehicle.id,%0A%20%20%20%20%20%20%20%20%20%20assigned_to:%20assignedTo,%0A%20%20%20%20%20%20%20%20%20%20type,%0A%20%20%20%20%20%20%20%20%20%20description,%0A%20%20%20%20%20%20%20%20%20%20status:%20%22New%22,%0A%20%20%20%20%20%20%20%20%7D,%0A%20%20%20%20%20%20%5D)%0A%20%20%20%20%20%20.select()%0A%20%20%20%20%20%20.single();%0A%0A%20%20%20%20if%20(jobError)%20throw%20jobError;%0A%20%20%20%20return%20%7B%20success:%20true,%20data:%20job%20%7D;%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20console.error(%22%E2%9D%8C%20Error%20adding%20job:%22,%20error);%0A%20%20%20%20return%20%7B%20success:%20false,%20error%20%7D;%0A%20%20%7D%0A%7D;%0A%0A/*%20============================================%0A%20%20%20UPDATE%20JOB%20STATUS%0A============================================%20*/%0Aexport%20const%20updateJobStatus%20=%20async%20(jobId,%20newStatus)%20=%3E%20%7B%0A%20%20const%20%7B%20data,%20error%20%7D%20=%20await%20supabase%0A%20%20%20%20.from(%22jobs%22)%0A%20%20%20%20.update(%7B%20status:%20newStatus%20%7D)%0A%20%20%20%20.eq(%22id%22,%20jobId)%0A%20%20%20%20.select()%0A%20%20%20%20.single();%0A%0A%20%20if%20(error)%20%7B%0A%20%20%20%20console.error(%22%E2%9D%8C%20Error%20updating%20job%20status:%22,%20error);%0A%20%20%20%20return%20%7B%20success:%20false,%20error%20%7D;%0A%20%20%7D%0A%0A%20%20return%20%7B%20success:%20true,%20data%20%7D;%0A%7D;%0A%0A/*%20============================================%0A%20%20%20SAVE%20VHC%20CHECKSHEET%0A%20%20%20(used%20for%20full%20VHC%20JSON%20from%20tech%20page)%0A============================================%20*/%0Aexport%20const%20saveChecksheet%20=%20async%20(jobNumber,%20checksheetData)%20=%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20data,%20error%20%7D%20=%20await%20supabase%0A%20%20%20%20%20%20.from(%22vhc_checks%22)%0A%20%20%20%20%20%20.upsert(%7B%20job_number:%20jobNumber,%20data:%20checksheetData%20%7D)%0A%20%20%20%20%20%20.select()%0A%20%20%20%20%20%20.single();%0A%0A%20%20%20%20if%20(error)%20throw%20error;%0A%20%20%20%20return%20%7B%20success:%20true,%20data%20%7D;%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20console.error(%22%E2%9D%8C%20Error%20saving%20checksheet:%22,%20error);%0A%20%20%20%20return%20%7B%20success:%20false,%20error%20%7D;%0A%20%20%7D%0A%7D;%0A%0A/*%20============================================%0A%20%20%20SAVE%20INDIVIDUAL%20VHC%20SECTION%0A%20%20%20(used%20for%20single%20sections%20like%20Wheels%20&%20Tyres)%0A============================================%20*/%0Aexport%20const%20saveVhcSection%20=%20async%20(jobNumber,%20sectionKey,%20sectionData)%20=%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20data:%20existing,%20error:%20fetchError%20%7D%20=%20await%20supabase%0A%20%20%20%20%20%20.from(%22vhc_checks%22)%0A%20%20%20%20%20%20.select(%22id,%20data%22)%0A%20%20%20%20%20%20.eq(%22job_number%22,%20jobNumber)%0A%20%20%20%20%20%20.single();%0A%0A%20%20%20%20const%20updatedData%20=%20!fetchError%20&&%20existing?.data%0A%20%20%20%20%20%20?%20%7B%20...existing.data,%20%5BsectionKey%5D:%20sectionData%20%7D%0A%20%20%20%20%20%20:%20%7B%20%5BsectionKey%5D:%20sectionData%20%7D;%0A%0A%20%20%20%20const%20%7B%20data,%20error%20%7D%20=%20await%20supabase%0A%20%20%20%20%20%20.from(%22vhc_checks%22)%0A%20%20%20%20%20%20.upsert(%7B%20job_number:%20jobNumber,%20data:%20updatedData%20%7D)%0A%20%20%20%20%20%20.select()%0A%20%20%20%20%20%20.single();%0A%0A%20%20%20%20if%20(error)%20throw%20error;%0A%20%20%20%20return%20%7B%20success:%20true,%20data%20%7D;%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20console.error(%22%E2%9D%8C%20Error%20saving%20VHC%20section:%22,%20error);%0A%20%20%20%20return%20%7B%20success:%20false,%20error%20%7D;%0A%20%20%7D%0A%7D;%0A%0A/*%20============================================%0A%20%20%20SAVE%20WRITE-UP%0A============================================%20*/%0Aexport%20const%20saveWriteUp%20=%20async%20(jobNumber,%20writeUpData)%20=%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20data,%20error%20%7D%20=%20await%20supabase%0A%20%20%20%20%20%20.from(%22job_writeups%22)%0A%20%20%20%20%20%20.upsert(%7B%0A%20%20%20%20%20%20%20%20job_number:%20jobNumber,%0A%20%20%20%20%20%20%20%20...writeUpData,%0A%20%20%20%20%20%20%20%20updated_at:%20new%20Date(),%0A%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20.select()%0A%20%20%20%20%20%20.single();%0A%0A%20%20%20%20if%20(error)%20throw%20error;%0A%20%20%20%20return%20%7B%20success:%20true,%20data%20%7D;%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20console.error(%22%E2%9D%8C%20Error%20saving%20write-up:%22,%20error);%0A%20%20%20%20return%20%7B%20success:%20false,%20error%20%7D;%0A%20%20%7D%0A%7D;%0A%0A/*%20============================================%0A%20%20%20UPLOAD%20JOB%20FILE%0A============================================%20*/%0Aexport%20const%20uploadJobFile%20=%20async%20(jobNumber,%20file,%20folder%20=%20%22dealer-files%22)%20=%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20filePath%20=%20%60$%7Bfolder%7D/$%7BjobNumber%7D/$%7BDate.now()%7D_$%7Bfile.name%7D%60;%0A%20%20%20%20const%20%7B%20error:%20uploadError%20%7D%20=%20await%20supabase.storage%0A%20%20%20%20%20%20.from(%22job-files%22)%0A%20%20%20%20%20%20.upload(filePath,%20file,%20%7B%20upsert:%20true%20%7D);%0A%20%20%20%20if%20(uploadError)%20throw%20uploadError;%0A%0A%20%20%20%20const%20%7B%20data:%20publicUrlData%20%7D%20=%20supabase.storage%0A%20%20%20%20%20%20.from(%22job-files%22)%0A%20%20%20%20%20%20.getPublicUrl(filePath);%0A%0A%20%20%20%20await%20supabase.from(%22job_files%22).insert(%5B%0A%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20job_number:%20jobNumber,%0A%20%20%20%20%20%20%20%20file_name:%20file.name,%0A%20%20%20%20%20%20%20%20file_url:%20publicUrlData.publicUrl,%0A%20%20%20%20%20%20%20%20folder,%0A%20%20%20%20%20%20%20%20uploaded_at:%20new%20Date(),%0A%20%20%20%20%20%20%7D,%0A%20%20%20%20%5D);%0A%0A%20%20%20%20return%20%7B%20success:%20true,%20url:%20publicUrlData.publicUrl%20%7D;%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20console.error(%22%E2%9D%8C%20Error%20uploading%20job%20file:%22,%20error);%0A%20%20%20%20return%20%7B%20success:%20false,%20error%20%7D;%0A%20%20%7D%0A%7D;%0A%0A/*%20============================================%0A%20%20%20DELETE%20JOB%20FILE%0A============================================%20*/%0Aexport%20const%20deleteJobFile%20=%20async%20(fileId)%20=%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20data:%20file,%20error:%20fetchError%20%7D%20=%20await%20supabase%0A%20%20%20%20%20%20.from(%22job_files%22)%0A%20%20%20%20%20%20.select(%22file_url%22)%0A%20%20%20%20%20%20.eq(%22id%22,%20fileId)%0A%20%20%20%20%20%20.single();%0A%20%20%20%20if%20(fetchError)%20throw%20fetchError;%0A%0A%20%20%20%20const%20filePath%20=%20file.file_url.split(%22/job-files/%22)%5B1%5D;%0A%20%20%20%20const%20%7B%20error:%20deleteError%20%7D%20=%20await%20supabase.storage%0A%20%20%20%20%20%20.from(%22job-files%22)%0A%20%20%20%20%20%20.remove(%5BfilePath%5D);%0A%20%20%20%20if%20(deleteError)%20throw%20deleteError;%0A%0A%20%20%20%20await%20supabase.from(%22job_files%22).delete().eq(%22id%22,%20fileId);%0A%20%20%20%20return%20%7B%20success:%20true%20%7D;%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20console.error(%22%E2%9D%8C%20Error%20deleting%20job%20file:%22,%20error);%0A%20%20%20%20return%20%7B%20success:%20false,%20error%20%7D;%0A%20%20%7D%0A%7D;%0A%0A/*%20============================================%0A%20%20%20GET%20JOB%20FILES%0A============================================%20*/%0Aexport%20const%20getJobFiles%20=%20async%20(jobNumber)%20=%3E%20%7B%0A%20%20const%20%7B%20data,%20error%20%7D%20=%20await%20supabase%0A%20%20%20%20.from(%22job_files%22)%0A%20%20%20%20.select(%22id,%20file_name,%20file_url,%20uploaded_at,%20folder%22)%0A%20%20%20%20.eq(%22job_number%22,%20jobNumber)%0A%20%20%20%20.order(%22uploaded_at%22,%20%7B%20ascending:%20false%20%7D);%0A%0A%20%20if%20(error)%20%7B%0A%20%20%20%20console.error(%22%E2%9D%8C%20Error%20fetching%20job%20files:%22,%20error);%0A%20%20%20%20return%20%5B%5D;%0A%20%20%7D%0A%0A%20%20return%20data%20%7C%7C%20%5B%5D;%0A%7D;%0A%0A/*%20============================================%0A%20%20%20GET%20JOBS%20BY%20DATE%0A============================================%20*/%0Aexport%20const%20getJobsByDate%20=%20async%20(date)%20=%3E%20%7B%0A%20%20const%20%7B%20data,%20error%20%7D%20=%20await%20supabase%0A%20%20%20%20.from(%22appointments%22)%0A%20%20%20%20.select(%60%0A%20%20%20%20%20%20id,%0A%20%20%20%20%20%20scheduled_time,%0A%20%20%20%20%20%20notes,%0A%20%20%20%20%20%20job:jobs(%0A%20%20%20%20%20%20%20%20id,%0A%20%20%20%20%20%20%20%20job_number,%0A%20%20%20%20%20%20%20%20type,%0A%20%20%20%20%20%20%20%20status,%0A%20%20%20%20%20%20%20%20vehicle:vehicles(%0A%20%20%20%20%20%20%20%20%20%20registration,%0A%20%20%20%20%20%20%20%20%20%20make,%0A%20%20%20%20%20%20%20%20%20%20model%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20)%0A%20%20%20%20%60)%0A%20%20%20%20.eq(%22scheduled_time%22,%20date);%0A%0A%20%20if%20(error)%20%7B%0A%20%20%20%20console.error(%22%E2%9D%8C%20Error%20fetching%20jobs%20by%20date:%22,%20error);%0A%20%20%20%20return%20%5B%5D;%0A%20%20%7D%0A%0A%20%20return%20data.map((a)%20=%3E%20(%7B%0A%20%20%20%20appointmentId:%20a.id,%0A%20%20%20%20scheduledTime:%20a.scheduled_time,%0A%20%20%20%20notes:%20a.notes,%0A%20%20%20%20job:%20%7B%0A%20%20%20%20%20%20id:%20a.job?.id,%0A%20%20%20%20%20%20jobNumber:%20a.job?.job_number,%0A%20%20%20%20%20%20type:%20a.job?.type,%0A%20%20%20%20%20%20status:%20a.job?.status,%0A%20%20%20%20%20%20reg:%20a.job?.vehicle?.registration,%0A%20%20%20%20%20%20make:%20a.job?.vehicle?.make,%0A%20%20%20%20%20%20model:%20a.job?.vehicle?.model,%0A%20%20%20%20%7D,%0A%20%20%7D));%0A%7D;