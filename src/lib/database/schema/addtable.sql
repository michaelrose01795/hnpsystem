-- =============================================================================
-- HNP System â€” Schema Migrations
-- =============================================================================
-- This file adds the consolidated master employee table and removes unused tables.
-- Safe to run multiple times (uses IF NOT EXISTS / IF EXISTS).
-- =============================================================================


-- =============================================================================
-- 1. MASTER EMPLOYEE PROFILE TABLE (hr_employee_profiles)
-- =============================================================================
-- Single source of truth for all employee HR data.
-- Linked to the users table via user_id (one profile per user).
-- Used by: /api/hr/employees, /api/profile/me, /api/profile/emergency-contact
-- =============================================================================

CREATE TABLE IF NOT EXISTS public.hr_employee_profiles (
  profile_id    bigint        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  user_id       integer       NOT NULL UNIQUE,
  department    text,
  job_title     text,
  employment_type    text,       -- Full-time, Part-time, Contract, etc.
  employment_status  text,       -- Active, On Leave, Terminated, etc.
  start_date    date,
  manager_id    integer,
  photo_url     text,
  emergency_contact  jsonb,      -- Stored as { "raw": "Name, Phone, Relationship" }
  documents     jsonb,
  contracted_hours             numeric,
  hourly_rate                  numeric,
  overtime_rate                numeric,
  annual_salary                numeric,
  payroll_reference            text,
  national_insurance_number    text,
  keycloak_user_id             text,
  home_address                 text,
  created_at    timestamp with time zone NOT NULL DEFAULT now(),
  updated_at    timestamp with time zone NOT NULL DEFAULT now(),

  CONSTRAINT hr_employee_profiles_pkey        PRIMARY KEY (profile_id),
  CONSTRAINT hr_employee_profiles_user_id_fkey FOREIGN KEY (user_id)
      REFERENCES public.users (user_id),
  CONSTRAINT hr_employee_profiles_manager_id_fkey FOREIGN KEY (manager_id)
      REFERENCES public.users (user_id)
);

-- Ensure all columns exist for databases that already have the table
-- (ALTER TABLE ADD COLUMN IF NOT EXISTS is safe to repeat)
ALTER TABLE public.hr_employee_profiles ADD COLUMN IF NOT EXISTS employment_status text;
ALTER TABLE public.hr_employee_profiles ADD COLUMN IF NOT EXISTS contracted_hours numeric;
ALTER TABLE public.hr_employee_profiles ADD COLUMN IF NOT EXISTS hourly_rate numeric;
ALTER TABLE public.hr_employee_profiles ADD COLUMN IF NOT EXISTS overtime_rate numeric;
ALTER TABLE public.hr_employee_profiles ADD COLUMN IF NOT EXISTS annual_salary numeric;
ALTER TABLE public.hr_employee_profiles ADD COLUMN IF NOT EXISTS payroll_reference text;
ALTER TABLE public.hr_employee_profiles ADD COLUMN IF NOT EXISTS national_insurance_number text;
ALTER TABLE public.hr_employee_profiles ADD COLUMN IF NOT EXISTS keycloak_user_id text;
ALTER TABLE public.hr_employee_profiles ADD COLUMN IF NOT EXISTS home_address text;


-- =============================================================================
-- 2. DROP UNUSED TABLES
-- =============================================================================
-- Tables below are defined in the schema but have zero references in the
-- codebase (no .from() calls, no joins, no API routes using them).
-- =============================================================================

-- customer_vehicle_links: Never referenced in any application code.
-- The app links customers to vehicles through the jobs table instead.
DROP TABLE IF EXISTS public.customer_vehicle_links;
