# VHC Status Matrix

## Field status matrix

| Field name | Possible values (code) | Meaning in UI | Where set | Where read | Section-specific rules | Related UI surfaces |
| --- | --- | --- | --- | --- | --- | --- |
| `vhc_checks.approval_status` | `pending`, `authorized`, `declined`, `completed` | Approval decision for a VHC item; drives status dot and sections in VHC summary. | `src/pages/api/vhc/update-item-status.js` called from `src/components/VHC/VhcDetailsPanel.js` (single + bulk updates). | `src/components/VHC/VhcDetailsPanel.js`, `src/lib/vhc/calculateVhcTotals.js` | Pending uses parts/labour completeness to show "Add labour", "Add parts", or "Awaiting decision". | VHC Summary tab in `src/components/VHC/VhcDetailsPanel.js` |
| `vhc_checks.display_status` | `red`, `amber`, `green`, `authorized`, `declined`, `completed` | Overrides which summary list a row appears in; `completed` keeps row in Authorized list but shows Completed status. | `src/pages/api/vhc/update-item-status.js` (implicit for authorized/declined/completed; can be explicitly passed for reset). | `src/components/VHC/VhcDetailsPanel.js`, `src/lib/vhc/calculateVhcTotals.js` | When present, replaces original severity; completed -> authorized list. | VHC Summary tab in `src/components/VHC/VhcDetailsPanel.js` |
| `vhc_checks.labour_complete` | `true`, `false` | Checkbox state in summary table for labour completeness. | `src/pages/api/vhc/update-item-status.js` (from VHC summary interactions). | `src/components/VHC/VhcDetailsPanel.js` | Used by `resolveRowStatusState` to show "Add labour" vs "Awaiting decision". | VHC Summary tab |
| `vhc_checks.parts_complete` | `true`, `false` | Auto-complete flag when parts cost exists or parts marked not required. | `src/components/VHC/VhcDetailsPanel.js` (auto-sync to API via `/api/vhc/update-item-status`). | `src/components/VHC/VhcDetailsPanel.js` | Used by `resolveRowStatusState` to show "Add parts" vs "Awaiting decision". | VHC Summary tab |
| `vhc_checks.approved_at`, `vhc_checks.approved_by` | timestamps / user identifiers | Timestamp + actor when approval moves to authorized/declined/completed. | `src/pages/api/vhc/update-item-status.js` | `src/components/VHC/VhcDetailsPanel.js` | None. | VHC Summary tab (status hover details via local state) |
| `jobs.vhc_required` | `true`, `false` | Whether VHC is required for the job. | Job update flows in `src/lib/database/jobs.js` and external data entry (no direct VHC UI set). | `src/lib/services/vhcStatusService.js`, `src/lib/status/jobStatusSnapshot.js` | Determines whether workflow status can be `not_required` vs `pending`. | Status sidebar snapshot, dashboards |
| `jobs.vhc_completed_at` | timestamp or null | VHC completed marker for workflow status and blockers. | `src/lib/services/jobStatusService.js` via `autoSetVHCCompleteStatus`. | `src/lib/status/jobStatusSnapshot.js`, `src/lib/services/vhcStatusService.js` | Used for workflow status (`completed`) and blocking reasons. | Status sidebar snapshot, dashboards |
| `jobs.vhc_sent_at` | timestamp or null | VHC sent marker for workflow status. | `src/lib/services/jobStatusService.js` via `autoSetVHCSentStatus`; `src/lib/services/vhcStatusService.js` | `src/lib/status/jobStatusSnapshot.js`, `src/lib/services/vhcStatusService.js` | Used for workflow status (`sent`) and gating authorize/decline actions. | Status sidebar snapshot, dashboards |
| `jobs.additional_work_authorized_at` | timestamp or null | Additional work authorized marker for workflow status. | `src/lib/services/jobStatusService.js` via `autoSetAdditionalWorkRequiredStatus`. | `src/lib/status/jobStatusSnapshot.js` | Used for workflow status (`authorised`). | Status sidebar snapshot |
| `vhc_workflow_status.status` | free text; typical values in `src/lib/vhc/summary.js`: "VHC not started", "In progress", "Waiting for parts", "Sent to customer", "Awaiting approval", "Approved", "Declined", "Completed" | Display status for customer portal summaries. | No write path found in this repo. | `src/customers/hooks/useCustomerPortalData.js`, `src/components/VHC/VhcDetailsPanel.js` (workflow data load) | Not applied to VHC summary table; only high-level portal labels. | Customer portal summaries |
| `vhc_send_history.sent_at` | timestamp | Logged when VHC is sent to customer. | `src/lib/services/vhcStatusService.js` | `src/lib/status/jobStatusSnapshot.js` (via `vhc_sent_at`) | Contributes to workflow status and history. | Status sidebar snapshot |
| `vhc_authorizations.authorized_at` | timestamp | Logged when customer authorizes additional work. | `src/lib/services/vhcStatusService.js` | `src/lib/status/jobStatusSnapshot.js` | Contributes to workflow status (`authorised`). | Status sidebar snapshot |
| `vhc_declinations.declined_at` | timestamp | Logged when customer declines additional work. | `src/lib/services/vhcStatusService.js`, `src/pages/api/vhc/declinations/index.js` | `src/lib/status/jobStatusSnapshot.js` | Contributes to workflow status (`declined`). | Status sidebar snapshot |
| VHC builder payload `concerns[].status` | `Red`, `Amber`, `Green` | Severity per concern; rolled up to item + section severity. | VHC section modals (External/Internal/Underside/Service/Wheels/Brakes). | `src/lib/vhc/summary.js`, `src/components/VHC/VhcDetailsPanel.js` | Red/amber items become summary rows; green only appears in Green Checks section. | VHC Summary + Health Check tabs |
| VHC builder payload `brakesHubs.*.status` | `Red`, `Amber`, `Green` (pads/discs), `Good`/`Monitor`/`Replace` (drums) | Severity for brake pad/disc/drum sections; normalized in summary. | `src/components/VHC/BrakesHubsDetailsModal.js` | `src/lib/vhc/summary.js`, `src/components/VHC/VhcDetailsPanel.js` | Drum status normalized by `normaliseStatus` (Good->Green, Monitor->Amber, Replace->Red). | VHC Summary + Health Check tabs |
| VHC builder payload `serviceIndicator.serviceChoice`, `serviceIndicator.oilStatus` | `reset`, `not_required`, `no_reminder`, `indicator_on`; `Good`, `Bad`, `EV` | Service indicator and oil status influence severity in summary. | `src/components/VHC/ServiceIndicatorDetailsModal.js` | `src/lib/vhc/summary.js` | Oil status: Bad->Red; Good/EV->Green. | VHC Summary + Health Check tabs |

## Summary row logic by section (VHC summary/health check)

| Section name | Row type | Fields used | Logic (exact conditions in code) | UI label or badge shown | Color mapping | Where the row status is rendered |
| --- | --- | --- | --- | --- | --- | --- |
| Wheels & Tyres | Wheel rows (NSF/OSF/NSR/OSR) and Spare/Kit | VHC builder payload: `wheelsTyres.*.tread`, `wheelsTyres.*.concerns[].status` | `determineTreadSeverity` uses average tread depth: <=2.5 -> Red, <=3.5 -> Amber, else Green. Row status is dominant of tread severity + concern statuses (`determineDominantStatus`). | Badge uses normalized Red/Amber/Green label. | `SEVERITY_THEME` in `VhcDetailsPanel`; tyre diagram uses danger/advisory/good. | `src/lib/vhc/summary.js` + `src/components/VHC/VhcDetailsPanel.js` (Summary + Health Check tabs) |
| Brakes & Hubs | Front/Rear Pads | `frontPads.measurement`, `frontPads.status`, `frontPads.concerns[].status` (same for rear) | Row status = `normaliseStatus(pad.status)` or dominant concern status. Measurement displayed but not used to set status in summary. | Badge shows normalized status (Red/Amber/Green). | `SEVERITY_THEME` in `VhcDetailsPanel`; brake diagram uses critical/advisory/good. | `src/lib/vhc/summary.js` + `src/components/VHC/VhcDetailsPanel.js` |
| Brakes & Hubs | Front/Rear Discs | `disc.measurements.status`, `disc.visual.status`, `disc.concerns[].status` | Row status = dominant of measurement status + visual status + concern statuses. | Badge shows normalized status (Red/Amber/Green). | `SEVERITY_THEME` in `VhcDetailsPanel`. | `src/lib/vhc/summary.js` + `src/components/VHC/VhcDetailsPanel.js` |
| Brakes & Hubs | Rear Drums | `rearDrums.status`, `rearDrums.concerns[].status` | Status normalized by `normaliseStatus` (Good->Green, Monitor->Amber, Replace->Red) or concern status. | Badge shows normalized status. | `SEVERITY_THEME` in `VhcDetailsPanel`. | `src/lib/vhc/summary.js` + `src/components/VHC/VhcDetailsPanel.js` |
| Service Indicator & Under Bonnet | Service reminder/oil item | `serviceChoice`, `oilStatus`, `concerns[].status` | `derivedOilStatus` maps Bad->Red, Good/EV->Green; row status is `normaliseStatus(service.status)` or dominant of serviceChoice + derivedOilStatus. Concerns add Red/Amber/Green counts. | Badge shows normalized status; concern pills show Red/Amber/Green counts. | `SEVERITY_THEME` in `VhcDetailsPanel`; pill styles in modal. | `src/lib/vhc/summary.js` + `src/components/VHC/VhcDetailsPanel.js` |
| External | Concern rows per category | `externalInspection.*.concerns[].status` | Each concern becomes its own row; status comes from concern status. If no concerns, entry status can be used but modal does not set it. | Concern status text (Red/Amber/Green). | `SEVERITY_THEME` in `VhcDetailsPanel`. | `src/lib/vhc/summary.js` + `src/components/VHC/VhcDetailsPanel.js` |
| Internal | Concern rows per category | `internalElectrics.*.concerns[].status` | Same as External: one row per concern with its status. | Concern status text (Red/Amber/Green). | `SEVERITY_THEME` in `VhcDetailsPanel`. | `src/lib/vhc/summary.js` + `src/components/VHC/VhcDetailsPanel.js` |
| Underside | Concern rows per category | `underside.*.concerns[].status` | Same as External: one row per concern with its status. | Concern status text (Red/Amber/Green). | `SEVERITY_THEME` in `VhcDetailsPanel`. | `src/lib/vhc/summary.js` + `src/components/VHC/VhcDetailsPanel.js` |
| Summary table (all sections) | Summary row status dot | `vhc_checks.approval_status`, `vhc_checks.labour_complete`, `vhc_checks.parts_complete`, parts costs, labour hours, parts-not-required | `resolveRowStatusState` order: if approval status is completed -> Completed (green tick). If authorized -> Approved (green). If declined -> Declined (red cross). Else (pending): if missing labour and parts -> "Add labour & parts"; missing labour -> "Add labour"; missing parts -> "Add parts"; otherwise "Awaiting decision". | Status dot tooltip shows label; status column uses colored dot. | Colors: success for approved/completed, danger for declined, warning for missing/awaiting. | `src/components/VHC/VhcDetailsPanel.js` in Summary tab tables |
